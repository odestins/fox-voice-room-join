<!DOCTYPE html>
<html>
<head>
  <title>Join Fox Voice Room</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #1a1a2e; color: #fff; min-height: 100vh; }
    h1 { color: #6366f1; text-align: center; }
    .container { background: #16213e; padding: 30px; border-radius: 16px; text-align: center; }
    button { padding: 16px 32px; font-size: 18px; background: #6366f1; color: white; border: none; border-radius: 12px; cursor: pointer; margin: 10px; }
    button:disabled { background: #4b5563; cursor: not-allowed; }
    #status { margin-top: 20px; padding: 15px; border-radius: 8px; font-size: 16px; }
    .connecting { background: #fef3c7; color: #92400e; }
    .connected { background: #d1fae5; color: #065f46; }
    .error { background: #fee2e2; color: #991b1b; }
    #audioControls { margin-top: 20px; display: none; }
    audio { width: 100%; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Fox Voice Room</h1>
    <p>Click to join the voice conversation with Fox.</p>
    <button id="joinBtn" onclick="joinRoom()">Join Room</button>
    <div id="status"></div>
    <div id="audioControls">
      <p>Fox's audio:</p>
      <audio id="audioPlayer" controls autoplay></audio>
    </div>
  </div>

  <script type="module">
    import * as Livekit from 'https://cdn.jsdelivr.net/npm/livekit-client@latest/+esm';
    
    const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ2aWRlbyI6eyJyb29tSm9pbiI6dHJ1ZSwicm9vbSI6ImZveC12b2ljZS1yb29tIiwiY2FuUHVibGlNoI6dHJ1ZSwiY2FuU3Vic2NyaWJlIjp0cnVlLCJjYW5QdWJsaXNoRGF0YSI6dHJ1ZX0sInN1YiI6IlN0YW4iLCJpc3MiOiJBUElzVHRGSHZMM2JpVmYiLCJuYmYiOjE3NzExNTQwNzMsImV4cCI6MTc3MTE3NTY3M30._GdVpG80W9MYJyVvMQG0G8MVOaKxpew8OaHXXde00Wg";
    const SERVER_URL = "wss://onetesting-06fiqirn.livekit.cloud";
    
    let room = null;

    function showStatus(message, type) {
      document.getElementById('status').className = type;
      document.getElementById('status').textContent = message;
    }

    window.joinRoom = async function() {
      showStatus('Connecting...', 'connecting');
      document.getElementById('joinBtn').disabled = true;
      
      try {
        // Get microphone access first
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        console.log('Got microphone access');
        
        // Create room
        room = new Livekit.Room();
        
        // Handle connection
        room.on('connected', () => {
          showStatus('Connected!', 'connected');
          document.getElementById('joinBtn').style.display = 'none';
          document.getElementById('audioControls').style.display = 'block';
        });
        
        room.on('disconnected', () => {
          showStatus('Disconnected.', 'info');
          document.getElementById('joinBtn').style.display = 'inline-block';
          document.getElementById('joinBtn').disabled = false;
          document.getElementById('audioControls').style.display = 'none';
        });
        
        // Handle incoming audio
        room.on('trackSubscribed', (track) => {
          if (track.kind === Livekit.TrackKind.Audio) {
            const audio = track.attach();
            document.getElementById('audioPlayer').srcObject = new MediaStream([track.mediaStreamTrack]);
          }
        });
        
        // Connect
        await room.connect(SERVER_URL, TOKEN);
        console.log('Connected to room');
        
        // Publish microphone using createLocalTracks
        const localTracks = await Livekit.createLocalTracks({
          audio: true,
          video: false
        });
        
        for (const track of localTracks) {
          await room.localParticipant.publishTrack(track);
          console.log('Published track:', track.kind);
        }
        
      } catch (e) {
        console.error('Error:', e);
        showStatus('Error: ' + e.message, 'error');
        document.getElementById('joinBtn').disabled = false;
      }
    };
  </script>
</body>
</html>
